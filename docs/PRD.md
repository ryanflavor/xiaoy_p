# xiaoy Product Requirements Document (PRD)

**Author:** ryan
**Date:** 2025-10-20
**Project Level:** 3
**Target Scale:** Production

---

## Goals and Background Context

### Goals

- 在 4–5 个窗口并开与峰值 4k tick/s 场景下，UI 稳定 ≥ 60 FPS，端到端延迟 P95 < 120ms、P99 < 180ms。
- 单用户仅 1 条 WebSocket 连接，采用 SharedWorker 扇出，支持多标签页一致性与资源复用。
- 建立统一消息与权限治理：以 NATS/JetStream 为中枢，Schema Registry + TS/Python 代码生成 100% 覆盖，遵循“仅追加”兼容策略。
- 内建可观测与降级：暴露帧率/延迟/带宽/慢消费者指标，支持自动降级与断线恢复 ≤ 3s。
- 交付最小可用席位（MVP）：行情/账户/风险核心面板、组订阅/筛选与 Top‑K，单活跃组下行 ≤ 2 Mbps。

### Background Context

现有 PyQt5 + ZMQ 桌面席位在高吞吐与多窗口并发场景下，难以稳定满足“低延迟、低抖动、可观测”的交互体验与治理诉求。为支撑 8–10 名交易员、≈50 个账户与多屏场景，系统需迁移到以 NATS/JetStream 为中枢的 Web 架构：服务端采用“33ms 增量 + 2–5s 快照”的聚合通道，按组输出 ROI 字段与 Top‑K；前端以单条 WebSocket 连接 + SharedWorker 扇出到多标签页，Worker 解码与 OffscreenCanvas 批量绘制，确保在峰值 ~4k tick/s 与 4–5 窗口并开时仍保持 ≥60 FPS 与端到端 P95 < 120ms。

本项目同时需要统一消息与权限治理（Schema Registry + TS/Python 代码生成、NKey/JWT 与 Subject ACL 最小权限）、可观测与降级（帧率/延迟/带宽/慢消费者指标、自动降级与断线恢复 ≤ 3s），以及 UI 侧 at‑most‑once 的低延迟快路径与 JetStream 审计/回放的稳态慢路径。关键风险在于 UI 抖动与背压扩散、组订阅/聚合成为单点、权限错配等；因此需通过“仅追加”兼容策略和显式慢消费者保护来降低演进风险。

### Primary Persona

- 单一主角：Trader（交易员）。
- 其余“风控/运营、平台/运维、策略工程师”等不作为人物角色，而是“系统使能（Enabler）”职责；对应能力以 NFR 或 Enabler 故事形式体现，目标不变：服务 Trader 的更快更稳。

---

## Requirements

### Functional Requirements

以下为 Level 3 共 22 条功能性需求（FR），含关键接受标准（选摘）。

- FR001: 增量 33ms 周期（滑窗 p95 ≤ 40ms/p99 ≤ 50ms），按组路由与节流可配置。
- FR002: 快照 2–5s，携带与增量一致的序列/版本，支持断点重建（重建 ≤ 1s）。
- FR003: 单条 WebSocket 连接（TLS+JWT/NKey），断线指数回退+抖动+并发上限，防重连风暴。
  - 验收：断线后 ≤ 3s 恢复到原面板与订阅；可观测重连曲线与并发上限。
- FR004: SharedWorker 扇出；无 SAB 走结构化克隆；启用 SAB 必须通过 COOP/COEP 自检。
  - 验收：跨源隔离探针自检通过率 100%。
- FR005: 订阅/筛选/Top‑K 变更至可见 ≤ 500ms；SharedWorker 16–33ms 批量合并与去重。
- FR006: 多窗口（≥4）布局与状态保存；切换不引入额外连接或重复解码。
- FR007: Worker 解码 + OffscreenCanvas 增量绘制；渲染“时间预算”每帧 ≤ 8ms，超预算切片。
- FR008: UI 通道 at‑most‑once；丢帧/合并阈值与面板优先级可配置（高优先级保真）。
- FR009: 账户/风险 1–2s 节奏与阈值告警/熔断联动。
- FR010: 指令请求‑应答：幂等键、超时与重试上限；重复提交防护与审计打点。
- FR011: Schema Registry + TS/Python 代码生成；CI 强制“仅追加”兼容检查。
- FR012: Subject ACL 最小权限与主题级审计日志。
- FR013: 端到端观测：adapter→aggregator→WS→UI 埋点，输出 p50/p95/p99、慢消费者事件与近 N 窗口。
- FR014: 降级三级：采样降频→字段裁剪→面板停更；含恢复条件与用户提示。
- FR015: 会话恢复 ≤ 3s；版本单调性校验；不一致自动请求全量快照，失败进入只读降级并告警。
- FR016: SoA TypedArray 环形缓冲；硬/软上限与回压信号；超限按优先级丢弃低价值批次。
- FR017: ROI 字段与 Top‑K 策略可热更新与灰度生效。
- FR018: JetStream 审计/回放：按主题/时间段查询，支持回放基准测试。
- FR019: 环境与发布：dev/prod 隔离、特性开关与安全审计开关。
- FR020: 权限化 UI（单一 Trader 视角）：基于权限隐藏/禁用敏感动作与面板；未来如扩展额外 persona 再细化 RBAC。
- FR021: 需求整形：订阅与事件在 SharedWorker/网关两侧最小间隔节流，防订阅风暴。
- FR022: 运行时兼容守护：未知字段容忍并打点；检测到破坏性变更进入保护模式与回退建议。

### Non-Functional Requirements

- NFR001 性能与时延（UI 与端到端）
  - UI 帧时：rAF 帧 p95 ≤ 16.7ms、p99 ≤ 25ms（交易时段）。
  - 端到端：adapter→aggregator→WS→UI 渲染 P95 < 120ms、P99 < 180ms（4–5 窗口并开、峰值 ~4k tick/s）。
  - 资源预算：主线程 CPU p95 < 30%，总 CPU p95 < 50%，JS Heap p95 < 512MB；GC Major < 1 次/分钟。

- NFR002 可用性与恢复力（交易时段）
  - 服务可用性：99.9%（Aggregator/WS 网关），计划维护窗口需提前公告且避开交易时段。
  - 故障恢复：关键链路 MTTD ≤ 5 分钟、MTTR ≤ 30 分钟；客户端会话恢复 ≤ 3 秒（见 FR015）。
  - 降级策略：当触发慢消费者/超预算时按 FR014 执行并记录事件。

- NFR003 安全与合规
  - 传输安全：全链路 TLS，鉴权采用 JWT/NKey；最小权限 Subject ACL。
  - 审计与留痕：关键操作与订阅/指令事件审计留痕；审计日志保留 ≥ 90 天。
  - 机密管理：密钥轮换 ≤ 90 天；凭据不入库不入前端包；CI 扫描密钥泄漏。

- NFR004 可观测性与运维
  - 指标：输出 p50/p95/p99、慢消费者、丢帧/合并、重连与订阅风暴计数；Prometheus/OpenTelemetry 采集。
  - 告警：基于 SLO 与错误预算建立多阈值告警；SLO 违约占比 > 1%/日触发 P1。
  - 可视化：提供运维仪表盘（链路与前端关键指标），15 分钟内完成初步定位（含相关追踪与日志）。

- NFR005 可扩展性与容量
  - 规模目标：稳定支撑平均 ~2k tick/s、峰值 ~4k tick/s；4–5 窗口并开、~100 可见行/屏。
  - 余量：常态负载下资源利用率 ≤ 50%，留有 ≥ 2× 突发余量；订阅/事件整形与节流（见 FR021）。
  - 兼容：Chrome 稳定版为目标浏览器；必须启用 Chrome 硬件加速；启用 SharedArrayBuffer 必须通过 COOP/COEP 与跨源隔离自检；如运行于禁用硬件加速的远程/虚拟桌面环境，应通过 FR014/FR017/FR021 的降级策略（采样/裁剪/降低 Top‑K/停更次要面板）维持可用。

---

## User Journeys

### Journey 1 — 监控与切换交易组（Trader 主路径）
- 触发：交易员登录并进入实时看板，默认加载最近使用的交易组与面板布局。
- 前置：单连接已建立（FR003），SharedWorker 扇出正常（FR004），订阅整形/节流启用（FR021）。
- 步骤：
  1) 在“组搜索”中输入关键词，看到候选组列表与 Top‑K 预览。
  2) 勾选/切换交易组与筛选条件；面板数据在 ≤500ms 内更新（FR005）。
  3) 调整 Top‑K 与列集（ROI 字段），面板与图表即时增量刷新（FR001/FR007/FR017）。
  4) 观察关键指标（FPS、端到端延迟、带宽、慢消费者）随操作变化（FR013）。
- 决策/分支：
  - 若检测到慢消费者/资源超限 → 依策略降级（采样→裁剪→停更），并在 UI 明示（FR014）。
  - 若订阅抖动/风暴风险上升 → SharedWorker/网关侧最小间隔节流生效（FR021）。
- 验收：P95 响应 ≤500ms；FPS ≥60；端到端 P95 <120ms；降级触发/恢复均有提示（FR014）。

### Journey 2 — 策略下单与确认（Trader 价值路径）
- 触发：在“手选T型报价/自动生成”生成目标合约组合后，进入“策略下单”面板（AlgoManagerSimple/AlgoGenerator）。
- 前置：用户具备相应角色权限（FR020/FR012）。
- 步骤：
  1) 选择账户与标的，输入价格/数量/方向，系统校验表单与风险阈值（NFR003/FR009）。
  2) 选择算法模板与参数（速度、轮数、间隔、追单时间、持续时间、摆单比例、价格偏移、开平策略等），点击“策略下单”。
  3) 前端生成幂等键并通过请求‑应答通道发送（FR010）。
  4) 在 1–2s 内收到成功 ACK 并回显订单状态；若超时触发重试与提示。
  4) 订单事件进入审计流水并可回放（FR018/NFR003）。
- 决策/分支：
  - 失败/超时：重试至上限，仍失败则熔断并提示人工确认（FR010/FR026）。
  - 权限不足：UI 禁用提交并提示（FR020/FR012）。
- 验收：提交→ACK ≤2s；重复提交被幂等拒绝并留痕；失败路径有明确回退与提示；生成→下单链路可在 UI 与日志中追踪。

### Journey 3 — 风险告警处理（Trader 视角）
- 触发：账户/风险面板出现阈值越界高亮并伴随告警事件（FR009/FR013）。
- 步骤：
  1) 点击告警，自动定位到相关标的与组合的详情面板（深链）。
  2) 查看最近窗口内端到端指标与慢消费者事件记录（FR013）。
  3) 选择“降级优先级”或“强制保真”面板策略；必要时切换订阅/字段裁剪（FR014/FR017/FR021）。
  4) 标记告警已处理并记录处置备注，供审计/回放（FR018/NFR003）。
- 决策/分支：
  - 若版本不一致/数据错位 → 触发全量快照重建或进入只读降级并告警（FR015）。
  - 若持续慢消费者 → 提示用户合并面板或降低 Top‑K，并记录事件。
- 验收：定位与处置全流程 ≤2 分钟；处置动作与事件均可审计/回放。

> 备注：如未来判断项目需升级为 Level 4，可在此基础上增加更多 persona 与边界场景（如多租户、跨市场切换、复盘/回放长历史交互等）。

---

## UX Design Principles

- 即时性优先、稳态不抖动
  - 稳定 ≥60 FPS，减少布局抖动与重排；关键面板保真优先（见 FR008/FR014）。
- 单连接一致性与最小惊扰
  - SharedWorker 单连接扇出，跨标签共享订阅与缓存；切换组/视图尽量无闪烁。
- 可观测、可降级、可恢复
  - UI 内可见 FPS/延迟/带宽/慢消费者；触发降级与恢复均明确提示；断线恢复≤3s（FR013–FR015）。
- 以交易效率为中心
  - 键鼠快捷与“价格随行情”输入；一键委托/全撤有清晰确认与回退（FR010）。
- 状态可追溯与可配置
  - 订阅/Top‑K/列集可保存与灰度；角色化 UI 控制敏感功能可见性（FR017/FR020）。
- 容错与一致性守护
  - 版本/快照不一致自动修复；未知字段容忍并打点（FR015/FR022）。

---

## User Interface Design Goals

- 登录与环境切换
  - 屏幕：登录（用户名/密码）、环境选择（实盘/模拟/测试）、“修改密码”入口、首登引导。
  - 成功后加载上次布局与订阅；提供“标的筛选”对话（树形：交易所→组合→子标的）。

- 主看板（多面板布局，可最少 4 个并行）
  - 左侧：组搜索/订阅与 Top‑K；中部：行情/账户/风险核心面板；右侧：交易侧栏（可折叠）。
  - 面板通用：列表与图表增量绘制，列集可配置；Top‑K/筛选变更 ≤ 500ms 可见（FR001/FR005/FR007/FR017）。
  - 指标浮层：FPS、端到端 p50/p95/p99、带宽与慢消费者计数（FR013）。

- 策略下单面板（AlgoManagerSimple/AlgoGenerator 的 Web 对等物）
  - 参数：速度（order_speed）、轮数（pair_numbers）、每轮间隔（interval）、追单时间（chase_interval）、持续时间（finish_time）、摆单比例（order_ratio）、价格偏移（price_offset）、开平（offset）、开平策略（lock）。
  - 动作：选择算法模板 → 调整参数 → “策略下单”；订单回执与错误提示清晰（FR010）。
  - 生成对接：与“手选T型报价/自动生成”联动展示待下单的合约组合，并可一键带入策略参数。

- 风险与告警
  - 阈值越界高亮；点击跳转详情并给出处置动作（降级/强制保真/调整订阅）。
  - 告警事件与处置留痕，支持检索与回放（FR009/FR018）。

- 布局与状态管理
  - 保存/恢复窗口布局与订阅；深链直达特定组合/标的；多标签一致性由 SharedWorker 统一维护（FR004）。

- 性能/兼容性
  - Chrome 稳定版目标；启用 SharedArrayBuffer 时强制 COOP/COEP 与跨源隔离自检通过；在资源紧张时优先保证核心交易/风险面板（NFR001/005）。

### 模块总览（MainWindow 入口）
- 手选T型报价（MGeneratorWidget）
  - 作用：人工挑选期权合约，实时查看 T 型报价与希腊值，形成候选组合。
  - 关键 UI：合约选择、T 型矩阵、指标列、生成数据信号（与策略下单联动）。
- 自动生成（AGeneratorWidget）
  - 作用：按参数（到期、Delta 区间、方向、数量等）自动生成组合建议。
  - 关键 UI：参数面板、生成/清空、结果表格（支持批量带入策略下单）。
- 自动解析（SignalSchemeGUI + AutoGeneratorWidget）
  - 作用：从“外部信号/文本”一键解析为“生成器模板 + 算法参数”的完整方案；支持增改删并保存方案。
  - 关键 UI：信号输入区、方案编辑区（AutoGeneratorWidget）、算法参数区（AlgoManagerSimpleTab）、方案列表（增改删）。
- 虚拟账户监控（VirtualAccountMonitor）
  - 作用：虚拟账户资金、持仓、盈亏、风险指标监控；选择虚拟网关参与策略下单。
  - 关键 UI：账户选择、持仓/资金表、选择开关（与策略下单联动）。
- 策略下单（AlgoGenerator/AlgoManagerSimple）
  - 作用：承接“手选/自动生成/自动解析”的组合，选择算法模板与参数，一键下单。
  - 关键 UI：模板 Tab、参数表（速度/间隔/追单/持续/摆单比例/价格偏移/开平/策略）、下单/清空。
- 算法监控（AlgoPortfolioMonitorTable）
  - 作用：运行中算法的状态可视化与控制（暂停、停止、进度、异常）。
  - 关键 UI：算法列表、状态/进度/异常列、控制按钮、日志区。

---

## Epic List

- Epic 1: 基础设施与单连接骨架（Foundation & Single-Connection）
  - 目标：建立可部署基础（仓库/CI、配置、技术决策落地）；实现 NATS→WS 网关与单连接 SharedWorker 扇出骨架；前端指标埋点与最小可见面板（占位列表/图表）。
  - 依赖：—
  - 预估故事数：8–12

- Epic 2: 虚拟账户监控（Virtual Account Monitor）
  - 目标：交付虚拟账户资金/持仓/盈亏监控；选择虚拟网关参与策略下单；与账户/网关状态联动可视。
  - 依赖：Epic 1（基础通信与单连接埋点）
  - 预估故事数：8–12

- Epic 3: 手选T型报价与核心可视（Manual T-Shape Quotes）
  - 目标：交付手选T型报价视图（MGenerator 等效 Web）、ROI 字段/Top‑K 配置、OffscreenCanvas 增量绘制与键鼠高效交互；指标浮层可视。
  - 依赖：Epic 1（渲染与数据骨架）
  - 预估故事数：8–12

- Epic 4: 自动生成与自动解析（Auto Generator & Auto Parsing）
  - 目标：实现自动生成（AGenerator 等效 Web）与“信号→方案”自动解析（SignalScheme + AutoGenerator 等效）；方案增改删与一键带入策略参数。
  - 依赖：Epic 1、Epic 3（数据/可视化与选择链路）
  - 预估故事数：6–10

- Epic 5: 策略下单与算法执行集成（Algo Ordering & Execution）
  - 目标：策略下单面板（AlgoManagerSimple/AlgoGenerator 等效 Web），参数化模板选择与幂等请求‑应答；订单回执/失败回退与审计打点；算法监控联动。
  - 依赖：Epic 1、Epic 2、Epic 3/4（账户与组合来源、下单链路）
  - 预估故事数：8–12

> **Note:** Detailed epic breakdown with full story specifications is available in [epics.md](./epics.md)

---

## Out of Scope

- 本地长历史回放与复杂审计 UI（保留 JetStream 服务端能力与后端回放接口）。
- 完整 RBAC 多租户门户与精细化审计流水 UI（本期仅最小权限与主题级审计）。
- WebGPU/高阶 3D 图形渲染（采用 Canvas/OffscreenCanvas 方案）。
- 前端直接消费 JetStream 的离线回放（仅提供后端接口与回放基准测试）。
- 完整的跨市场/跨交易所多集群联邦治理（本期聚焦单集群内网场景）。
- 复杂策略可视化与策略编排工作流（本期聚焦 Algo 简版参数化下单）。
